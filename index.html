<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>室內設計工作室財務管理</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-info {
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-info:hover {
            background-color: #2563eb; /* blue-600 */
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem;
            width: 100%;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* ring-indigo-200 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">室內設計工作室財務管理</h1>
        <p class="text-center text-gray-600 mb-6">使用者ID: <span id="user-id-display" class="font-semibold text-indigo-600">載入中...</span></p>

        <!-- Navigation Bar -->
        <nav class="bg-white p-2 rounded-xl shadow-lg mb-8 flex flex-wrap justify-center gap-2 sm:gap-4">
            <button id="nav-dashboard-btn" class="flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer bg-blue-600 text-white shadow-md transform scale-105">儀表板</button>
            <button id="nav-projects-btn" class="flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer bg-white text-gray-700 hover:bg-blue-50 hover:text-blue-600">專案列表</button>
        </nav>

        <!-- Overall Dashboard Section -->
        <div id="dashboard-section" class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">總覽儀表板</h2>
            <!-- Time Range Selector -->
            <div class="mb-8 flex justify-center gap-3">
                <button id="time-range-month" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200">本月</button>
                <button id="time-range-quarter" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200">本季</button>
                <button id="time-range-year" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-md">本年</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-10">
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200">
                    <p class="text-lg font-medium text-blue-700">總收入</p>
                    <p id="total-income" class="text-3xl font-bold text-blue-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg shadow-sm border border-red-200">
                    <p class="text-lg font-medium text-red-700">總支出</p>
                    <p id="total-expense" class="text-3xl font-bold text-red-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-sm border border-green-200">
                    <p class="text-lg font-medium text-green-700">總淨利潤</p>
                    <p id="net-profit" class="text-3xl font-bold text-green-800">NT$ 0</p>
                </div>
            </div>

            <!-- Project Net Profit Ranking -->
            <div class="mb-10">
                <h3 class="text-xl font-bold mb-4 text-gray-800">專案淨利排名</h3>
                <div id="project-profit-ranking-container" class="overflow-x-auto rounded-lg shadow-sm border border-gray-100">
                    <!-- Project profit ranking table will be rendered here -->
                    <p class="text-center text-gray-600 py-4" id="no-ranking-data">尚無專案數據可供排名。</p>
                </div>
            </div>

            <!-- Dummy Data Generator -->
            <div class="mt-8 p-6 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200 text-center">
                <h3 class="text-xl font-bold text-yellow-800 mb-4">虛擬資料生成器</h3>
                <p class="text-gray-700 mb-4">點擊下方按鈕可為過去 12 個月生成虛擬專案和交易數據，以便測試應用程式功能和儀表板顯示。</p>
                <button id="generate-dummy-data-btn" class="px-6 py-3 rounded-lg shadow-md font-semibold transition-all duration-200 transform hover:scale-105 bg-yellow-600 text-white hover:bg-yellow-700">
                    生成虛擬資料
                </button>
                <p class="text-sm text-gray-600 mt-2">注意：此操作將新增大量資料，請謹慎使用。</p>
            </div>
        </div>

        <!-- Project List Section -->
        <div id="project-list-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">專案列表</h2>
                <button id="add-project-btn" class="btn-primary">新增專案</button>
            </div>
            <!-- Search and Filter Section -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="search-project-name" class="block text-gray-700 text-sm font-medium mb-2">搜尋專案名稱:</label>
                    <input type="text" id="search-project-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="輸入專案名稱...">
                </div>
                <div>
                    <label for="filter-start-date" class="block text-gray-700 text-sm font-medium mb-2">開始日期起:</label>
                    <input type="date" id="filter-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
                <div>
                    <label for="filter-end-date" class="block text-gray-700 text-sm font-medium mb-2">結束日期迄:</label>
                    <input type="date" id="filter-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
            </div>
            <div id="projects-container" class="space-y-4">
                <!-- Projects will be loaded here -->
            </div>
            <!-- Moved outside the container to prevent it from being cleared -->
            <p class="text-center text-gray-500 mt-4" id="no-projects-message">目前沒有專案。點擊「新增專案」開始記錄！</p>
        </div>

        <!-- Add/Edit Project Form Section -->
        <div id="project-form-section" class="card hidden">
            <h2 id="project-form-title" class="text-2xl font-semibold text-gray-700 mb-4">新增專案</h2>
            <form id="project-form" class="space-y-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                    <input type="text" id="project-name" name="projectName" required class="w-full">
                </div>
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">客戶名稱</label>
                    <input type="text" id="client-name" name="clientName" class="w-full">
                </div>
                <div>
                    <label for="estimated-revenue" class="block text-sm font-medium text-gray-700 mb-1">預估收入 (NT$)</label>
                    <input type="number" id="estimated-revenue" name="estimatedRevenue" min="0" step="1" required class="w-full">
                </div>
                <div>
                    <label for="project-status" class="block text-sm font-medium text-gray-700 mb-1">專案狀態</label>
                    <select id="project-status" name="status" required class="w-full">
                        <option value="規劃中">規劃中</option>
                        <option value="施工中">施工中</option>
                        <option value="驗收中">驗收中</option>
                        <option value="已結案">已結案</option>
                        <option value="暫停">暫停</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">起始日期</label>
                        <input type="date" id="start-date" name="startDate" class="w-full">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" id="end-date" name="endDate" class="w-full">
                    </div>
                </div>
                <div>
                    <label for="project-description" class="block text-sm font-medium text-gray-700 mb-1">專案描述</label>
                    <textarea id="project-description" name="description" rows="3" class="w-full"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-project-btn" class="btn-secondary">取消</button>
                    <button type="submit" class="btn-primary">儲存專案</button>
                </div>
                <input type="hidden" id="current-project-id">
            </form>
        </div>

        <!-- Project Detail Section (hidden by default) -->
        <div id="project-detail-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detail-project-name" class="text-2xl font-semibold text-gray-700">專案名稱</h2>
                <button id="back-to-projects-btn" class="btn-secondary">返回專案列表</button>
            </div>

            <div class="text-center text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-100 shadow-sm">
                <p class="mb-1 text-lg">客戶名稱: <span id="detail-client-name" class="font-semibold text-gray-800"></span></p>
                <p class="mb-1 text-lg">狀態: <span id="detail-project-status" class="font-semibold"></span></p>
                <p class="mb-1 text-lg">預估收入: <span id="detail-estimated-revenue" class="font-semibold text-gray-800">NT$ 0</span></p>
                <p class="mb-1 text-lg">開始日期: <span id="detail-start-date" class="font-semibold text-gray-800"></span></p>
                <p class="mb-4 text-lg">結束日期: <span id="detail-end-date" class="font-semibold text-gray-800"></span></p>
                <p class="mb-4 text-lg">描述: <span id="detail-project-description" class="font-semibold text-gray-800"></span></p>
                <button id="edit-project-info-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition-colors transform hover:scale-105 font-medium shadow-sm">編輯專案資訊</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200">
                    <p class="text-lg font-medium text-blue-700">實際收入</p>
                    <p id="detail-total-income" class="text-3xl font-bold text-blue-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg shadow-sm border border-red-200">
                    <p class="text-lg font-medium text-red-700">實際支出</p>
                    <p id="detail-total-expense" class="text-3xl font-bold text-red-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-sm border border-green-200">
                    <p class="text-lg font-medium text-green-700">淨利</p>
                    <p id="detail-net-profit" class="text-3xl font-bold text-green-800">NT$ 0</p>
                    <p id="detail-gross-margin" class="text-sm text-gray-600 mt-2">毛利率: 0%</p>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">交易明細</h3>
                <button id="add-transaction-btn" class="btn-primary">新增交易</button>
            </div>

            <div id="transactions-container" class="space-y-3">
                <!-- Transactions will be loaded here -->
                <p class="text-center text-gray-500" id="no-transactions-message">此專案目前沒有交易記錄。</p>
            </div>
        </div>

        <!-- Add/Edit Transaction Form Section (hidden by default) -->
        <div id="transaction-form-section" class="card hidden">
            <h2 id="transaction-form-title" class="text-2xl font-semibold text-gray-700 mb-4">新增交易</h2>
            <form id="transaction-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">交易類型</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transactionType" value="income" checked>
                            <span class="ml-2 text-gray-700">收入</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transactionType" value="expense">
                            <span class="ml-2 text-gray-700">支出</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="date" id="transaction-date" name="date" required class="w-full">
                </div>
                <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金額 (NT$)</label>
                    <input type="number" id="transaction-amount" name="amount" min="0" step="1" required class="w-full">
                </div>
                <div>
                    <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                    <select id="transaction-category" name="category" required class="w-full">
                        <!-- Categories will be dynamically loaded/selected based on type -->
                    </select>
                </div>
                <div>
                    <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">付款/收款方式</label>
                    <select id="payment-method" name="paymentMethod" class="w-full">
                        <option value="">請選擇方式</option>
                        <option value="銀行轉帳">銀行轉帳</option>
                        <option value="現金">現金</option>
                        <option value="支票">支票</option>
                        <option value="信用卡">信用卡</option>
                    </select>
                </div>
                <div>
                    <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-1">發票/收據號碼</label>
                    <input type="text" id="invoice-number" name="invoiceNumber" class="w-full" placeholder="例如：AB12345678">
                </div>
                <div id="expense-specific-fields">
                    <div>
                        <label for="tax-id" class="block text-sm font-medium text-gray-700 mb-1">供應商統一編號</label>
                        <input type="text" id="tax-id" name="taxId" class="w-full" maxlength="8" placeholder="例如：12345678">
                    </div>
                    <div>
                        <label for="supplier" class="block text-sm font-medium text-gray-700 mb-1">供應商/收款方</label>
                        <input type="text" id="supplier" name="supplier" class="w-full" placeholder="例如：XX材料行">
                    </div>
                </div>
                <div>
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                    <textarea id="transaction-description" name="description" rows="2" class="w-full"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-transaction-btn" class="btn-secondary">取消</button>
                    <button type="submit" class="btn-primary">儲存交易</button>
                </div>
                <input type="hidden" id="current-transaction-id">
                <input type="hidden" id="transaction-project-id">
            </form>
        </div>

        <!-- Custom Modal for Messages (Alert) -->
        <div id="alertDialog" class="modal">
            <div class="modal-content">
                <span class="close-button" id="alert-close-btn">&times;</span>
                <p id="alert-message" class="text-lg text-gray-700"></p>
                <div class="flex justify-end mt-4">
                    <button id="alert-ok-btn" class="btn-primary">確定</button>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Confirmation -->
        <div id="confirmDialog" class="modal">
            <div class="modal-content">
                <span class="close-button" id="confirm-close-btn">&times;</span>
                <p id="confirm-message" class="text-lg text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel-btn" class="btn-secondary">取消</button>
                    <button id="confirm-ok-btn" class="btn-danger">確定</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user info
        let app;
        let db;
        let auth;
        let userId;
        let appId;
        let currentProjectId = null; // To keep track of the currently viewed project
        let confirmResolver = null; // For custom confirmation dialog

        // Pre-defined categories for income and expense
        const incomeCategories = ['專案收入', '其他收入'];
        const expenseCategories = ['材料費', '施工費', '外包設計費', '運輸費', '水電瓦斯費', '租金', '辦公用品費', '交際費', '雜項支出', '其他支出'];
        const paymentMethods = ['銀行轉帳', '現金', '支票', '信用卡'];
        const projectStatuses = ['規劃中', '施工中', '驗收中', '已結案', '暫停'];


        // --- Utility Functions ---

        /**
         * Displays a custom alert modal message.
         * @param {string} message The message to display.
         * @returns {Promise<void>} A promise that resolves when the user clicks OK.
         */
        function showAlert(message) {
            const modal = document.getElementById('alertDialog');
            const modalMessage = document.getElementById('alert-message');
            const closeButton = document.getElementById('alert-close-btn');
            const okButton = document.getElementById('alert-ok-btn');

            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center

            return new Promise(resolve => {
                const closeHandler = () => {
                    modal.style.display = 'none';
                    closeButton.removeEventListener('click', closeHandler);
                    okButton.removeEventListener('click', closeHandler);
                    resolve();
                };
                closeButton.addEventListener('click', closeHandler);
                okButton.addEventListener('click', closeHandler);
                modal.addEventListener('click', (e) => { // Close if clicking outside modal content
                    if (e.target === modal) {
                        closeHandler();
                    }
                });
            });
        }

        /**
         * Displays a custom confirmation modal message.
         * @param {string} message The message to display.
         * @returns {Promise<boolean>} A promise that resolves with true if confirmed, false otherwise.
         */
        function showConfirm(message) {
            const modal = document.getElementById('confirmDialog');
            const modalMessage = document.getElementById('confirm-message');
            const closeButton = document.getElementById('confirm-close-btn');
            const okButton = document.getElementById('confirm-ok-btn');
            const cancelButton = document.getElementById('confirm-cancel-btn');

            modalMessage.textContent = message;
            modal.style.display = 'flex';

            return new Promise(resolve => {
                confirmResolver = resolve; // Store resolver for later use

                const clickHandler = (result) => {
                    modal.style.display = 'none';
                    closeButton.removeEventListener('click', () => clickHandler(false));
                    okButton.removeEventListener('click', () => clickHandler(true));
                    cancelButton.removeEventListener('click', () => clickHandler(false));
                    modal.removeEventListener('click', outsideClickHandler); // Remove outside click listener
                    confirmResolver = null; // Clear resolver
                    resolve(result);
                };

                const outsideClickHandler = (e) => {
                    if (e.target === modal) {
                        clickHandler(false); // Treat outside click as cancel
                    }
                };

                closeButton.addEventListener('click', () => clickHandler(false));
                okButton.addEventListener('click', () => clickHandler(true));
                cancelButton.addEventListener('click', () => clickHandler(false));
                modal.addEventListener('click', outsideClickHandler);
            });
        }

        /**
         * Formats a number as New Taiwan Dollar (NTD).
         * @param {number} amount The amount to format.
         * @returns {string} Formatted string, e.g., "NT$ 10,000".
         */
        function formatCurrency(amount) {
            // Ensure amount is rounded to integer for display
            return `NT$ ${new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(amount || 0))}`;
        }

        /**
         * Populates the category dropdown based on the selected transaction type.
         * @param {string} type 'income' or 'expense'.
         * @param {string} selectedCategory The category to pre-select (optional).
         */
        function populateCategories(type, selectedCategory = '') {
            const categorySelect = document.getElementById('transaction-category');
            categorySelect.innerHTML = ''; // Clear existing options

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '請選擇類別';
            categorySelect.appendChild(defaultOption);

            const relevantCategories = type === 'income' ? incomeCategories : expenseCategories;
            relevantCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedCategory) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
        }

        /**
         * Toggles visibility of expense-specific fields in transaction form.
         * @param {string} type 'income' or 'expense'.
         */
        function toggleExpenseFields(type) {
            const expenseFields = document.getElementById('expense-specific-fields');
            if (type === 'expense') {
                expenseFields.classList.remove('hidden');
            } else {
                expenseFields.classList.add('hidden');
            }
        }

        // --- UI State Management ---

        /**
         * Shows a specific section and hides others.
         * @param {string} sectionId The ID of the section to show.
         */
        function showSection(sectionId) {
            const sections = ['dashboard-section', 'project-list-section', 'project-form-section', 'project-detail-section', 'transaction-form-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update navigation bar active state
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            });
            if (sectionId === 'dashboard-section') {
                document.getElementById('nav-dashboard-btn').classList.add('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                document.getElementById('nav-dashboard-btn').classList.remove('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            } else if (sectionId === 'project-list-section' || sectionId === 'project-form-section' || sectionId === 'project-detail-section' || sectionId === 'transaction-form-section') {
                document.getElementById('nav-projects-btn').classList.add('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                document.getElementById('nav-projects-btn').classList.remove('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            }
        }

        /**
         * Resets a form.
         * @param {HTMLFormElement} formElement The form to reset.
         */
        function resetForm(formElement) {
            formElement.reset();
            const hiddenIdField = formElement.querySelector('input[type="hidden"][id*="-id"]');
            if (hiddenIdField) {
                hiddenIdField.value = '';
            }
            // Reset radio buttons if they exist in the form
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (radio.name === 'transactionType') { // Specific to transaction form
                    radio.checked = (radio.value === 'income');
                }
            });
            toggleExpenseFields('income'); // Reset expense fields visibility
        }

        // --- Firebase Initialization and Authentication ---

        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // Get app ID and Firebase config from global variables provided by the environment
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Use the user-provided Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyBAuk3H_xDDi7tezkHjHOWws66i53ZBAsg",
                    authDomain: "accountinglan.firebaseapp.com",
                    projectId: "accountinglan",
                    storageBucket: "accountinglan.firebasestorage.app",
                    messagingSenderId: "797875094335",
                    appId: "1:797875094335:web:00d22e25927e081a4f098a"
                };

                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration not found. Please ensure __firebase_config is set.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (error) {
                        console.warn("Custom token sign-in failed, attempting anonymous sign-in:", error);
                        // If custom token fails (e.g., mismatch), fall back to anonymous
                        if (error.code === 'auth/custom-token-mismatch' || error.code === 'auth/invalid-custom-token') {
                             await signInAnonymously(auth);
                        } else {
                            throw error; // Re-throw other unexpected errors
                        }
                    }
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        console.log("Firebase initialized and authenticated. User ID:", userId);
                        // Start listening to data once authenticated
                        setupFirestoreListeners();
                        showSection('dashboard-section'); // Show dashboard after auth
                    } else {
                        userId = null;
                        document.getElementById('user-id-display').textContent = '未登入';
                        console.log("No user signed in.");
                        showAlert("無法驗證使用者，請重新整理頁面。");
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showAlert(`應用程式啟動失敗：${error.message}`);
            }
        }

        // --- Firestore Data Operations ---

        /**
         * Sets up real-time listeners for projects and transactions.
         */
        function setupFirestoreListeners() {
            if (!userId || !db) {
                console.warn("Firestore not ready. Skipping listener setup.");
                return;
            }

            // Listener for all projects
            const projectsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
            onSnapshot(projectsColRef, async (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                // Re-fetch all transactions to ensure latest actuals are used for project list and dashboard
                await updateAllProjectsAndTransactions();
                renderProjects(allProjects); // Use the globally updated allProjects
                calculateOverallProfit(allProjects, allTransactions, document.querySelector('#time-range-year.bg-blue-600') ? 'year' : (document.querySelector('#time-range-quarter.bg-blue-600') ? 'quarter' : 'month')); // Update overall profit based on current time range
                renderProjectProfitRanking(allProjects, allTransactions); // Update ranking
            }, (error) => {
                console.error("Error listening to projects:", error);
                showAlert("載入專案時發生錯誤。");
            });

            // Listener for all transactions (needed for overall calculations and project list actuals)
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            onSnapshot(transactionsColRef, async (snapshot) => {
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                // Re-fetch all projects to ensure latest actuals are used for project list and dashboard
                await updateAllProjectsAndTransactions();
                renderProjects(allProjects); // Use the globally updated allProjects
                calculateOverallProfit(allProjects, allTransactions, document.querySelector('#time-range-year.bg-blue-600') ? 'year' : (document.querySelector('#time-range-quarter.bg-blue-600') ? 'quarter' : 'month')); // Update overall profit based on current time range
                renderProjectProfitRanking(allProjects, allTransactions); // Update ranking

                // If currently viewing a project detail, refresh its transactions
                if (currentProjectId) {
                    showProjectDetail(currentProjectId); // This will re-trigger its own onSnapshot for transactions
                }
            }, (error) => {
                console.error("Error listening to transactions:", error);
                showAlert("載入交易時發生錯誤。");
            });
        }

        let allProjects = [];
        let allTransactions = [];

        /**
         * Fetches all projects and transactions and updates global variables.
         * This is crucial for accurate overall and project-level calculations.
         */
        async function updateAllProjectsAndTransactions() {
            if (!userId || !db) return;

            const projectsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/projects`));
            const transactionsSnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/transactions`));

            allProjects = projectsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allTransactions = transactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Calculate actual revenue/expense/net profit for each project
            allProjects = allProjects.map(project => {
                const projectTransactions = allTransactions.filter(t => t.projectId === project.id);
                const actualRevenue = projectTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                const actualExpense = projectTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                return {
                    ...project,
                    actualRevenue,
                    actualExpense,
                    actualNetProfit: actualRevenue - actualExpense
                };
            });
        }


        /**
         * Adds or updates a project in Firestore.
         * @param {object} projectData The project data.
         * @param {string} [projectId] The ID of the project to update (if editing).
         */
        async function saveProject(projectData, projectId = null) {
            try {
                if (!userId) {
                    await showAlert("使用者未登入，無法儲存專案。");
                    return;
                }

                const projectsColRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
                if (projectId) {
                    await setDoc(doc(projectsColRef, projectId), { ...projectData, updatedAt: serverTimestamp() }, { merge: true });
                    await showAlert("專案更新成功！");
                } else {
                    await addDoc(projectsColRef, { ...projectData, createdAt: serverTimestamp() });
                    await showAlert("專案新增成功！");
                }
                resetForm(document.getElementById('project-form'));
                showSection('project-list-section'); // Go back to project list
            }
             catch (error) {
                console.error("Error saving project:", error);
                showAlert(`儲存專案失敗：${error.message}`);
            }
        }

        /**
         * Deletes a project and its associated transactions from Firestore.
         * @param {string} projectId The ID of the project to delete.
         */
        async function deleteProject(projectId) {
            const confirmed = await showConfirm("確定要刪除此專案及其所有交易記錄嗎？此操作無法復原。");
            if (!confirmed) {
                return;
            }

            try {
                if (!userId) {
                    await showAlert("使用者未登入，無法刪除專案。");
                    return;
                }

                // Delete all transactions associated with the project first
                const transactionsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`), where("projectId", "==", projectId));
                const querySnapshot = await getDocs(transactionsQuery);
                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);

                // Then delete the project itself
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId));
                await showAlert("專案及其交易記錄已成功刪除。");
            } catch (error) {
                console.error("Error deleting project:", error);
                showAlert(`刪除專案失敗：${error.message}`);
            }
        }

        /**
         * Adds or updates a transaction in Firestore.
         * @param {object} transactionData The transaction data.
         * @param {string} projectId The ID of the project this transaction belongs to.
         * @param {string} [transactionId] The ID of the transaction to update (if editing).
         */
        async function saveTransaction(transactionData, projectId, transactionId = null) {
            try {
                if (!userId) {
                    await showAlert("使用者未登入，無法儲存交易。");
                    return;
                }

                // Round amount before saving
                transactionData.amount = Math.round(parseFloat(transactionData.amount || 0));

                const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                if (transactionId) {
                    await setDoc(doc(transactionsColRef, transactionId), { ...transactionData, updatedAt: serverTimestamp() }, { merge: true });
                    await showAlert("交易更新成功！");
                } else {
                    await addDoc(transactionsColRef, { ...transactionData, projectId, createdAt: serverTimestamp() });
                    await showAlert("交易新增成功！");
                }
                resetForm(document.getElementById('transaction-form'));
                // After saving, re-render the project detail view to show updated transactions
                if (currentProjectId) {
                    showProjectDetail(currentProjectId);
                }
            } catch (error) {
                console.error("Error saving transaction:", error);
                showAlert(`儲存交易失敗：${error.message}`);
            }
        }

        /**
         * Deletes a transaction from Firestore.
         * @param {string} transactionId The ID of the transaction to delete.
         */
        async function deleteTransaction(transactionId) {
            const confirmed = await showConfirm("確定要刪除此交易記錄嗎？");
            if (!confirmed) {
                return;
            }

            try {
                if (!userId) {
                    await showAlert("使用者未登入，無法刪除交易。");
                    return;
                }

                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, transactionId));
                await showAlert("交易記錄已成功刪除。");
                // After deleting, re-render the project detail view to reflect changes
                if (currentProjectId) {
                    showProjectDetail(currentProjectId);
                }
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showAlert(`刪除交易失敗：${error.message}`);
            }
        }

        // --- Rendering Functions ---

        /**
         * Renders the list of projects.
         * @param {Array<object>} projects The array of project objects.
         */
        function renderProjects(projects) {
            const projectsContainer = document.getElementById('projects-container');
            const noProjectsMessage = document.getElementById('no-projects-message');
            
            projectsContainer.innerHTML = ''; // Clear existing projects
            noProjectsMessage.classList.add('hidden'); // Hide the message initially

            const searchTerm = document.getElementById('search-project-name').value.toLowerCase();
            const filterStartDate = document.getElementById('filter-start-date').value;
            const filterEndDate = document.getElementById('filter-end-date').value;

            const filteredProjects = projects.filter(project => {
                const matchesName = project.projectName.toLowerCase().includes(searchTerm);

                const projectStartDate = project.startDate ? new Date(project.startDate) : null;
                const projectEndDate = project.endDate ? new Date(project.endDate) : null;

                const filterStart = filterStartDate ? new Date(filterStartDate) : null;
                const filterEnd = filterEndDate ? new Date(filterEndDate) : null;

                let matchesDate = true;
                if (filterStart) {
                    matchesDate = matchesDate && projectStartDate && projectStartDate >= filterStart;
                }
                if (filterEnd) {
                    const adjustedFilterEnd = new Date(filterEnd);
                    adjustedFilterEnd.setHours(23, 59, 59, 999); // End of day
                    matchesDate = matchesDate && projectEndDate && projectEndDate <= adjustedFilterEnd;
                }
                return matchesName && matchesDate;
            });

            if (filteredProjects.length === 0) {
                noProjectsMessage.classList.remove('hidden');
                return;
            }

            // Create table structure
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">專案名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">客戶名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">狀態</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">開始日期</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">預估收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際支出</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際淨利</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="projects-table-body">
                </tbody>
            `;
            projectsContainer.appendChild(table);
            const tableBody = document.getElementById('projects-table-body');

            filteredProjects.forEach(project => {
                const actualNetProfit = project.actualNetProfit; // Already calculated in updateAllProjectsAndTransactions

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-800">${project.projectName}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.clientName || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${
                            project.status === '已結案' ? 'bg-green-100 text-green-800' :
                            project.status === '施工中' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${project.status || '未設定'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.startDate || '未設定'}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.estimatedRevenue || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.actualRevenue || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.actualExpense || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm font-semibold ${actualNetProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(actualNetProfit)}
                    </td>
                    <td class="py-3 px-4 flex gap-2">
                        <button data-id="${project.id}" class="btn-info view-project-btn">查看詳情</button>
                        <button data-id="${project.id}" class="btn-secondary edit-project-btn">編輯</button>
                        <button data-id="${project.id}" class="btn-danger delete-project-btn">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach event listeners for project actions
            projectsContainer.querySelectorAll('.view-project-btn').forEach(button => {
                button.onclick = () => showProjectDetail(button.dataset.id);
            });
            projectsContainer.querySelectorAll('.edit-project-btn').forEach(button => {
                button.onclick = () => editProject(button.dataset.id);
            });
            projectsContainer.querySelectorAll('.delete-project-btn').forEach(button => {
                button.onclick = () => deleteProject(button.dataset.id);
            });
        }

        /**
         * Displays the details and transactions for a specific project.
         * @param {string} projectId The ID of the project to display.
         */
        async function showProjectDetail(projectId) {
            if (!userId || !db) {
                await showAlert("應用程式未準備好，請稍候。");
                return;
            }

            currentProjectId = projectId; // Set the current project ID

            try {
                const projectDocRef = doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId);
                const projectSnap = await getDoc(projectDocRef);

                if (!projectSnap.exists()) {
                    await showAlert("找不到此專案。");
                    showSection('project-list-section');
                    return;
                }

                const project = { id: projectSnap.id, ...projectSnap.data() };
                document.getElementById('detail-project-name').textContent = project.projectName;
                document.getElementById('detail-client-name').textContent = project.clientName || 'N/A';
                document.getElementById('detail-project-status').textContent = project.status || '未設定';
                document.getElementById('detail-estimated-revenue').textContent = formatCurrency(project.estimatedRevenue || 0);
                document.getElementById('detail-start-date').textContent = project.startDate || '未設定';
                document.getElementById('detail-end-date').textContent = project.endDate || '未設定';
                document.getElementById('detail-project-description').textContent = project.description || '無描述';

                document.getElementById('transaction-project-id').value = projectId; // Set hidden field for new transactions

                showSection('project-detail-section');

                // Listen for transactions specific to this project
                const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                const q = query(transactionsColRef, where("projectId", "==", projectId), orderBy("date", "desc"));

                onSnapshot(q, (snapshot) => {
                    const transactions = [];
                    snapshot.forEach(doc => {
                        transactions.push({ id: doc.id, ...doc.data() });
                    });
                    renderTransactions(transactions);
                    calculateProjectProfit(transactions);
                }, (error) => {
                    console.error("Error listening to project transactions:", error);
                    showAlert("載入專案交易時發生錯誤。");
                });

            } catch (error) {
                console.error("Error showing project detail:", error);
                showAlert(`顯示專案詳情失敗：${error.message}`);
            }
        }

        /**
         * Renders the list of transactions for the current project.
         * @param {Array<object>} transactions The array of transaction objects.
         */
        function renderTransactions(transactions) {
            const transactionsContainer = document.getElementById('transactions-container');
            transactionsContainer.innerHTML = ''; // Clear existing transactions
            document.getElementById('no-transactions-message').classList.add('hidden');

            if (transactions.length === 0) {
                document.getElementById('no-transactions-message').classList.remove('hidden');
                return;
            }

            // Create table structure
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">日期</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">類型</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">金額 (NT$)</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">類別</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">付款/收款方式</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">發票/收據號碼</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">供應商/統一編號</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">備註</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="transactions-table-body">
                </tbody>
            `;
            transactionsContainer.appendChild(table);
            const tableBody = document.getElementById('transactions-table-body');

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 transition-colors duration-150`;
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.date}</td>
                    <td class="py-3 px-4 text-sm font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.type === 'income' ? '收入' : '支出'}
                    </td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(transaction.amount)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.category || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.paymentMethod || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.invoiceNumber || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">
                        ${transaction.type === 'expense' ? `${transaction.supplier || '無'} (${transaction.taxId || '無'})` : 'N/A'}
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600 max-w-[150px] truncate">${transaction.description || '無'}</td>
                    <td class="py-3 px-4 flex gap-2">
                        <button data-id="${transaction.id}" class="bg-yellow-500 text-white px-3.5 py-1.5 rounded-md text-sm hover:bg-yellow-600 transition-colors transform hover:scale-105 edit-transaction-btn">編輯</button>
                        <button data-id="${transaction.id}" class="bg-red-500 text-white px-3.5 py-1.5 rounded-md text-sm hover:bg-red-600 transition-colors transform hover:scale-105 delete-transaction-btn">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach event listeners for transaction actions
            transactionsContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = () => editTransaction(button.dataset.id);
            });
            transactionsContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = () => deleteTransaction(button.dataset.id);
            });
        }

        /**
         * Calculates and displays the overall income, expense, and net profit based on a time range.
         * @param {Array<object>} projects The array of all project objects.
         * @param {Array<object>} transactions The array of all transaction objects.
         * @param {string} timeRange 'month', 'quarter', or 'year'.
         */
        function calculateOverallProfit(projects, transactions, timeRange) {
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date(now); // Clone now for endDate manipulation

            switch (timeRange) {
                case 'month':
                    startDate.setMonth(now.getMonth(), 1); // First day of current month
                    break;
                case 'quarter':
                    const currentMonth = now.getMonth();
                    const currentQuarterStartMonth = Math.floor(currentMonth / 3) * 3;
                    startDate.setMonth(currentQuarterStartMonth, 1);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear(), 0, 1); // First day of current year
                    break;
                default: // Default to year if invalid
                    startDate.setFullYear(now.getFullYear(), 0, 1);
                    break;
            }
            startDate.setHours(0, 0, 0, 0); // Start of the day for startDate
            endDate.setHours(23, 59, 59, 999); // End of the day for endDate

            const filteredTransactions = transactions.filter(txn => {
                const txnDate = new Date(txn.date); // Assuming txn.date is in YYYY-MM-DD format
                return txnDate >= startDate && txnDate <= endDate;
            });

            const totalIncome = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + Math.round(t.amount || 0), 0);

            const totalExpense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.round(t.amount || 0), 0);

            const netProfit = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('net-profit').textContent = formatCurrency(netProfit);
            document.getElementById('net-profit').classList.toggle('text-red-800', netProfit < 0);
            document.getElementById('net-profit').classList.toggle('text-green-800', netProfit >= 0);

            // Update time range button styles
            document.querySelectorAll('#dashboard-section .mb-8 button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            });
            document.getElementById(`time-range-${timeRange}`).classList.add('bg-blue-600', 'text-white', 'shadow-md');
            document.getElementById(`time-range-${timeRange}`).classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        }

        /**
         * Calculates and displays the income, expense, and net profit for a specific project.
         * @param {Array<object>} transactions The array of transaction objects for the current project.
         */
        function calculateProjectProfit(transactions) {
            const projectIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
            const projectExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
            const projectNetProfit = projectIncome - projectExpense;
            const grossMargin = projectIncome > 0 ? ((projectNetProfit / projectIncome) * 100).toFixed(0) : 0;

            document.getElementById('detail-total-income').textContent = formatCurrency(projectIncome);
            document.getElementById('detail-total-expense').textContent = formatCurrency(projectExpense);
            document.getElementById('detail-net-profit').textContent = formatCurrency(projectNetProfit);
            document.getElementById('detail-net-profit').classList.toggle('text-red-800', projectNetProfit < 0);
            document.getElementById('detail-net-profit').classList.toggle('text-green-800', projectNetProfit >= 0);
            document.getElementById('detail-gross-margin').textContent = `毛利率: ${grossMargin}%`;
        }

        /**
         * Renders the project net profit ranking table on the dashboard.
         * @param {Array<object>} projects The array of all project objects (with actuals calculated).
         * @param {Array<object>} transactions The array of all transaction objects.
         */
        function renderProjectProfitRanking(projects, transactions) {
            const rankingContainer = document.getElementById('project-profit-ranking-container');
            rankingContainer.innerHTML = ''; // Clear existing content
            document.getElementById('no-ranking-data').classList.add('hidden');

            const projectProfits = projects.map(project => {
                const projectTransactions = transactions.filter(t => t.projectId === project.id);
                const income = projectTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                const expense = projectTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                return {
                    id: project.id,
                    name: project.projectName,
                    startDate: project.startDate,
                    endDate: project.endDate,
                    income: income,
                    expense: expense,
                    netProfit: income - expense
                };
            }).sort((a, b) => b.netProfit - a.netProfit); // Sort by net profit descending

            if (projectProfits.length === 0) {
                document.getElementById('no-ranking-data').classList.remove('hidden');
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">專案名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">開始日期</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">結束日期</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">支出</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">淨利</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="project-ranking-table-body">
                </tbody>
            `;
            rankingContainer.appendChild(table);
            const tableBody = document.getElementById('project-ranking-table-body');

            projectProfits.forEach(project => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-800">${project.name}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.startDate || '未設定'}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.endDate || '未設定'}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.income)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.expense)}</td>
                    <td class="py-3 px-4 text-right text-sm font-semibold ${project.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(project.netProfit)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }


        // --- Form Handling ---

        /**
         * Shows the project form for adding a new project.
         */
        function showAddProjectForm() {
            document.getElementById('project-form-title').textContent = '新增專案';
            resetForm(document.getElementById('project-form'));
            document.getElementById('project-status').value = '規劃中'; // Default status
            document.getElementById('estimated-revenue').value = ''; // Clear estimated revenue
            showSection('project-form-section');
        }

        /**
         * Populates the project form with existing data for editing.
         * @param {string} projectId The ID of the project to edit.
         */
        async function editProject(projectId) {
            try {
                if (!userId || !db) {
                    await showAlert("應用程式未準備好，請稍候。");
                    return;
                }
                const projectDocRef = doc(db, `artifacts/${appId}/users/${userId}/projects`, projectId);
                const projectSnap = await getDoc(projectDocRef);

                if (projectSnap.exists()) {
                    const project = projectSnap.data();
                    document.getElementById('project-form-title').textContent = '編輯專案';
                    document.getElementById('current-project-id').value = projectId;
                    document.getElementById('project-name').value = project.projectName || '';
                    document.getElementById('client-name').value = project.clientName || '';
                    document.getElementById('estimated-revenue').value = project.estimatedRevenue || '';
                    document.getElementById('project-status').value = project.status || '規劃中';
                    document.getElementById('start-date').value = project.startDate || '';
                    document.getElementById('end-date').value = project.endDate || '';
                    document.getElementById('project-description').value = project.description || '';
                    showSection('project-form-section');
                } else {
                    await showAlert("找不到要編輯的專案。");
                }
            } catch (error) {
                console.error("Error editing project:", error);
                showAlert(`編輯專案失敗：${error.message}`);
            }
        }

        /**
         * Shows the transaction form for adding a new transaction to the current project.
         */
        function showAddTransactionForm() {
            document.getElementById('transaction-form-title').textContent = '新增交易';
            resetForm(document.getElementById('transaction-form'));
            // Set default date to today
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            populateCategories('income'); // Default to income categories
            toggleExpenseFields('income'); // Hide expense fields by default
            showSection('transaction-form-section');
        }

        /**
         * Populates the transaction form with existing data for editing.
         * @param {string} transactionId The ID of the transaction to edit.
         */
        async function editTransaction(transactionId) {
            try {
                if (!userId || !db) {
                    await showAlert("應用程式未準備好，請稍候。");
                    return;
                }
                const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, transactionId);
                const transactionSnap = await getDoc(transactionDocRef);

                if (transactionSnap.exists()) {
                    const transaction = transactionSnap.data();
                    document.getElementById('transaction-form-title').textContent = '編輯交易';
                    document.getElementById('current-transaction-id').value = transactionId;
                    document.getElementById('transaction-date').value = transaction.date || '';
                    
                    // Set radio button for type
                    document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
                        radio.checked = (radio.value === transaction.type);
                    });
                    toggleExpenseFields(transaction.type); // Show/hide expense fields based on type

                    document.getElementById('transaction-amount').value = transaction.amount || 0;
                    populateCategories(transaction.type || 'income', transaction.category); // Populate categories based on existing type and select existing category
                    document.getElementById('payment-method').value = transaction.paymentMethod || '';
                    document.getElementById('invoice-number').value = transaction.invoiceNumber || '';
                    document.getElementById('tax-id').value = transaction.taxId || '';
                    document.getElementById('supplier').value = transaction.supplier || '';
                    document.getElementById('transaction-description').value = transaction.description || '';
                    showSection('transaction-form-section');
                } else {
                    await showAlert("找不到要編輯的交易。");
                }
            } catch (error) {
                console.error("Error editing transaction:", error);
                showAlert(`編輯交易失敗：${error.message}`);
            }
        }

        /**
         * Generates dummy data (projects and transactions) for testing purposes.
         */
        async function generateDummyData() {
            const confirmed = await showConfirm("這將會新增大量的虛擬專案和交易資料。您確定要繼續嗎？");
            if (!confirmed) {
                return;
            }

            const generateBtn = document.getElementById('generate-dummy-data-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = '正在生成中...';

            try {
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth(); // 0-11

                for (let i = 0; i < 6; i++) { // Generate for past 6 months
                    const projectMonth = (currentMonth - i + 12) % 12; // Calculate month for project (0-11)
                    const projectYear = currentYear - (i > currentMonth ? 1 : 0); // Adjust year if month wraps around

                    const startDate = new Date(projectYear, projectMonth, 1);
                    const endDate = new Date(projectYear, projectMonth + 1, 0); // Last day of the month

                    const projectName = `${projectYear}年${projectMonth + 1}月設計專案 ${Math.random().toString(36).substring(2, 5)}`;
                    const clientName = `客戶 ${Math.random().toString(36).substring(2, 6)}`;
                    const estimatedRevenue = Math.round(Math.random() * (1500000 - 500000) + 500000); // 50萬 - 150萬
                    const status = projectStatuses[Math.floor(Math.random() * projectStatuses.length)];

                    const projectDocRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/projects`), {
                        projectName,
                        clientName,
                        status,
                        estimatedRevenue: estimatedRevenue,
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0],
                        description: `這是關於 ${projectName} 的虛擬描述。`,
                        createdAt: serverTimestamp()
                    });

                    // Generate 2-4 income transactions for the project
                    const numIncomes = Math.floor(Math.random() * 3) + 2; // 2 to 4 incomes
                    for (let j = 0; j < numIncomes; j++) {
                        const incomeAmount = Math.round(Math.random() * (estimatedRevenue / numIncomes * 1.2 - estimatedRevenue / numIncomes * 0.8) + estimatedRevenue / numIncomes * 0.8);
                        const incomeDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())).toISOString().split('T')[0];
                        const incomeCategory = incomeCategories[Math.floor(Math.random() * incomeCategories.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];

                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), {
                            projectId: projectDocRef.id,
                            type: 'income',
                            amount: incomeAmount,
                            date: incomeDate,
                            category: incomeCategory,
                            paymentMethod: paymentMethod,
                            invoiceNumber: `INV-${Math.random().toString(36).substring(2, 10).toUpperCase()}`,
                            taxId: '', // Income won't have supplier tax ID
                            supplier: clientName, // Client name for income
                            description: `虛擬收入 - ${incomeCategory} ${j + 1}`,
                            createdAt: serverTimestamp()
                        });
                    }

                    // Generate 3-6 expense transactions for the project
                    const numExpenses = Math.floor(Math.random() * 4) + 3; // 3 to 6 expenses
                    for (let j = 0; j < numExpenses; j++) {
                        const expenseAmount = Math.round(Math.random() * (100000 - 5000) + 5000); // 5千 - 10萬
                        const expenseDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())).toISOString().split('T')[0];
                        const expenseCategory = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                        const supplierName = `供應商 ${Math.random().toString(36).substring(2, 6)}`;
                        const taxId = Math.floor(10000000 + Math.random() * 90000000).toString(); // 8-digit number

                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), {
                            projectId: projectDocRef.id,
                            type: 'expense',
                            amount: expenseAmount,
                            date: expenseDate,
                            category: expenseCategory,
                            paymentMethod: paymentMethod,
                            invoiceNumber: `EXP-${Math.random().toString(36).substring(2, 10).toUpperCase()}`,
                            taxId: taxId,
                            supplier: supplierName,
                            description: `虛擬支出 - ${expenseCategory} ${j + 1}`,
                            createdAt: serverTimestamp()
                        });
                    }
                }
                await showAlert("虛擬資料生成成功！");
            } catch (error) {
                console.error("生成虛擬資料失敗:", error);
                showAlert(`生成虛擬資料失敗: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成虛擬資料';
            }
        }


        // --- Event Listeners ---

        window.onload = initializeFirebaseAndAuth; // Initialize Firebase when the page loads

        // Navigation Bar Event Listeners
        document.getElementById('nav-dashboard-btn').addEventListener('click', () => showSection('dashboard-section'));
        document.getElementById('nav-projects-btn').addEventListener('click', () => showSection('project-list-section'));

        // Dashboard Time Range Event Listeners
        document.getElementById('time-range-month').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'month'));
        document.getElementById('time-range-quarter').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'quarter'));
        document.getElementById('time-range-year').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'year'));
        document.getElementById('generate-dummy-data-btn').addEventListener('click', generateDummyData);

        // Project List Search and Filter Event Listeners
        document.getElementById('search-project-name').addEventListener('input', () => renderProjects(allProjects));
        document.getElementById('filter-start-date').addEventListener('change', () => renderProjects(allProjects));
        document.getElementById('filter-end-date').addEventListener('change', () => renderProjects(allProjects));


        // Project Form Event Listeners
        document.getElementById('add-project-btn').addEventListener('click', showAddProjectForm);
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
            resetForm(document.getElementById('project-form'));
            showSection('project-list-section');
        });
        document.getElementById('project-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const projectId = document.getElementById('current-project-id').value;
            const projectName = document.getElementById('project-name').value.trim();
            const clientName = document.getElementById('client-name').value.trim();
            const estimatedRevenue = parseFloat(document.getElementById('estimated-revenue').value);
            const status = document.getElementById('project-status').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const description = document.getElementById('project-description').value.trim();

            if (!projectName || !clientName || isNaN(estimatedRevenue) || estimatedRevenue < 0 || !status) {
                showAlert("請填寫所有必填欄位並確保預估收入有效。");
                return;
            }

            const projectData = { projectName, clientName, estimatedRevenue: Math.round(estimatedRevenue), status, startDate, endDate, description };
            saveProject(projectData, projectId || null);
        });

        // Project Detail Event Listeners
        document.getElementById('back-to-projects-btn').addEventListener('click', () => {
            currentProjectId = null; // Clear current project
            showSection('project-list-section');
        });
        document.getElementById('add-transaction-btn').addEventListener('click', showAddTransactionForm);
        document.getElementById('edit-project-info-btn').addEventListener('click', () => {
            // Re-use the existing editProject function, passing the currentProjectId
            if (currentProjectId) {
                editProject(currentProjectId);
            } else {
                showAlert("無法編輯專案資訊，請先選擇一個專案。");
            }
        });


        // Transaction Form Event Listeners
        document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                populateCategories(e.target.value);
                toggleExpenseFields(e.target.value);
            });
        });

        document.getElementById('cancel-transaction-btn').addEventListener('click', () => {
            resetForm(document.getElementById('transaction-form'));
            if (currentProjectId) {
                showSection('project-detail-section'); // Go back to project detail
            } else {
                showSection('project-list-section'); // Fallback
            }
        });
        document.getElementById('transaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const transactionId = document.getElementById('current-transaction-id').value;
            const projectId = document.getElementById('transaction-project-id').value;
            const date = document.getElementById('transaction-date').value;
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const category = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const paymentMethod = document.getElementById('payment-method').value;
            const invoiceNumber = document.getElementById('invoice-number').value.trim();
            const taxId = document.getElementById('tax-id').value.trim();
            const supplier = document.getElementById('supplier').value.trim();
            const description = document.getElementById('transaction-description').value.trim();

            if (!date || !type || !category || isNaN(amount) || amount <= 0) {
                showAlert("請填寫所有必填欄位並確保金額有效。");
                return;
            }

            const transactionData = { date, type, category, amount: Math.round(amount), paymentMethod, invoiceNumber, taxId, supplier, description };
            saveTransaction(transactionData, projectId, transactionId || null);
        });

    </script>
</body>
</html>
