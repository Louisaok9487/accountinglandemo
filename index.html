<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>室內設計工作室財務管理 (演示版)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #fff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-info {
            background-color: #3b82f6; /* blue-500 */
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-info:hover {
            background-color: #2563eb; /* blue-600 */
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea,
        select {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem;
            width: 100%;
            font-size: 1rem;
            line-height: 1.5;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* ring-indigo-200 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container py-8">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8">室內設計工作室財務管理 (演示版)</h1>
        <!-- User ID display removed as it's a static demo -->

        <!-- Navigation Bar -->
        <nav class="bg-white p-2 rounded-xl shadow-lg mb-8 flex flex-wrap justify-center gap-2 sm:gap-4">
            <button id="nav-dashboard-btn" class="flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer bg-blue-600 text-white shadow-md transform scale-105">儀表板</button>
            <button id="nav-projects-btn" class="flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 cursor-pointer bg-white text-gray-700 hover:bg-blue-50 hover:text-blue-600">專案列表</button>
        </nav>

        <!-- Overall Dashboard Section -->
        <div id="dashboard-section" class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">總覽儀表板</h2>
            <!-- Time Range Selector -->
            <div class="mb-8 flex flex-wrap justify-center items-center gap-3">
                <button id="time-range-month" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200">本月</button>
                <button id="time-range-quarter" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200">本季</button>
                <button id="time-range-year" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-blue-600 text-white shadow-md">本年</button>
                <select id="year-selector" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    <!-- Years will be populated by JS -->
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-10">
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200">
                    <p id="total-income-title" class="text-lg font-medium text-blue-700">總收入</p>
                    <p id="total-income" class="text-3xl font-bold text-blue-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg shadow-sm border border-red-200">
                    <p id="total-expense-title" class="text-lg font-medium text-red-700">總支出</p>
                    <p id="total-expense" class="text-3xl font-bold text-red-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-sm border border-green-200">
                    <p id="net-profit-title" class="text-lg font-medium text-green-700">總淨利潤</p>
                    <p id="net-profit" class="text-3xl font-bold text-green-800">NT$ 0</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                <div class="card p-5">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">收入類別分佈</h3>
                    <canvas id="incomeCategoryPieChart"></canvas>
                    <p class="text-center text-gray-600 text-sm mt-2 hidden" id="no-income-chart-data">尚無收入數據。</p>
                </div>
                <div class="card p-5">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">支出類別分佈</h3>
                    <canvas id="expenseCategoryPieChart"></canvas>
                    <p class="text-center text-gray-600 text-sm mt-2 hidden" id="no-expense-chart-data">尚無支出數據。</p>
                </div>
            </div>
            <div class="card p-5 mb-10">
                <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">每月淨利潤趨勢 (<span id="monthly-profit-year"></span>)</h3>
                <canvas id="monthlyNetProfitLineChart"></canvas>
                <p class="text-center text-gray-600 text-sm mt-2 hidden" id="no-monthly-chart-data">尚無足夠數據繪製每月淨利潤趨勢圖。</p>
            </div>


            <!-- Project Net Profit Ranking -->
            <div class="mb-10">
                <h3 class="text-xl font-bold mb-4 text-gray-800">專案淨利排名</h3>
                <div id="project-profit-ranking-container" class="overflow-x-auto rounded-lg shadow-sm border border-gray-100">
                    <!-- Project profit ranking table will be rendered here -->
                </div>
                <!-- Moved outside the container to prevent it from being cleared -->
                <p class="text-center text-gray-600 py-4 hidden" id="no-ranking-data">尚無專案數據可供排名。</p>
            </div>

            <!-- Dummy Data Generator Removed -->
        </div>

        <!-- Project List Section -->
        <div id="project-list-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">專案列表</h2>
                <button id="add-project-btn" class="btn-primary">新增專案</button>
            </div>
            <!-- Search and Filter Section -->
            <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="search-project-name" class="block text-gray-700 text-sm font-medium mb-2">搜尋專案名稱:</label>
                    <input type="text" id="search-project-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="輸入專案名稱...">
                </div>
                <div>
                    <label for="filter-start-date" class="block text-gray-700 text-sm font-medium mb-2">開始日期起:</label>
                    <input type="date" id="filter-start-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
                <div>
                    <label for="filter-end-date" class="block text-gray-700 text-sm font-medium mb-2">結束日期迄:</label>
                    <input type="date" id="filter-end-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                </div>
            </div>
            <div id="projects-container" class="space-y-4">
                <!-- Projects will be loaded here -->
            </div>
            <!-- Moved outside the container to prevent it from being cleared -->
            <p class="text-center text-gray-500 mt-4 hidden" id="no-projects-message">目前沒有專案。點擊「新增專案」開始記錄！</p>
        </div>

        <!-- Add/Edit Project Form Section -->
        <div id="project-form-section" class="card hidden">
            <h2 id="project-form-title" class="text-2xl font-semibold text-gray-700 mb-4">新增專案</h2>
            <form id="project-form" class="space-y-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">專案名稱</label>
                    <input type="text" id="project-name" name="projectName" required class="w-full">
                </div>
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">客戶名稱</label>
                    <input type="text" id="client-name" name="clientName" class="w-full">
                </div>
                <div>
                    <label for="estimated-revenue" class="block text-sm font-medium text-gray-700 mb-1">預估收入 (NT$)</label>
                    <input type="number" id="estimated-revenue" name="estimatedRevenue" min="0" step="1" required class="w-full">
                </div>
                <div>
                    <label for="project-status" class="block text-sm font-medium text-gray-700 mb-1">專案狀態</label>
                    <select id="project-status" name="status" required class="w-full">
                        <option value="規劃中">規劃中</option>
                        <option value="施工中">施工中</option>
                        <option value="驗收中">驗收中</option>
                        <option value="已結案">已結案</option>
                        <option value="暫停">暫停</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">起始日期</label>
                        <input type="date" id="start-date" name="startDate" class="w-full">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" id="end-date" name="endDate" class="w-full">
                    </div>
                </div>
                <div>
                    <label for="project-description" class="block text-sm font-medium text-gray-700 mb-1">專案描述</label>
                    <textarea id="project-description" name="description" rows="3" class="w-full"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-project-btn" class="btn-secondary">取消</button>
                    <button type="submit" class="btn-primary">儲存專案</button>
                </div>
                <input type="hidden" id="current-project-id">
            </form>
        </div>

        <!-- Project Detail Section (hidden by default) -->
        <div id="project-detail-section" class="card hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="detail-project-name" class="text-2xl font-semibold text-gray-700">專案名稱</h2>
                <button id="back-to-projects-btn" class="btn-secondary">返回專案列表</button>
            </div>

            <div class="text-center text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg border border-gray-100 shadow-sm">
                <p class="mb-1 text-lg">客戶名稱: <span id="detail-client-name" class="font-semibold text-gray-800"></span></p>
                <p class="mb-1 text-lg">狀態: <span id="detail-project-status" class="font-semibold"></span></p>
                <p class="mb-1 text-lg">預估收入: <span id="detail-estimated-revenue" class="font-semibold text-gray-800">NT$ 0</span></p>
                <p class="mb-1 text-lg">開始日期: <span id="detail-start-date" class="font-semibold text-gray-800"></span></p>
                <p class="mb-4 text-lg">結束日期: <span id="detail-end-date" class="font-semibold text-gray-800"></span></p>
                <p class="mb-4 text-lg">描述: <span id="detail-project-description" class="font-semibold text-gray-800"></span></p>
                <button id="edit-project-info-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-600 transition-colors transform hover:scale-105 font-medium shadow-sm">編輯專案資訊</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                <div class="p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200">
                    <p class="text-lg font-medium text-blue-700">實際收入</p>
                    <p id="detail-total-income" class="text-3xl font-bold text-blue-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-red-50 rounded-lg shadow-sm border border-red-200">
                    <p class="text-lg font-medium text-red-700">實際支出</p>
                    <p id="detail-total-expense" class="text-3xl font-bold text-red-800">NT$ 0</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-sm border border-green-200">
                    <p class="text-lg font-medium text-green-700">淨利</p>
                    <p id="detail-net-profit" class="text-3xl font-bold text-green-800">NT$ 0</p>
                    <p id="detail-gross-margin" class="text-sm text-gray-600 mt-2">毛利率: 0%</p>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-700">交易明細</h3>
                <button id="add-transaction-btn" class="btn-primary">新增交易</button>
            </div>

            <div id="transactions-container" class="space-y-3">
                <!-- Transactions will be loaded here -->
                <p class="text-center text-gray-500 hidden" id="no-transactions-message">此專案目前沒有交易記錄。</p>
            </div>
        </div>

        <!-- Add/Edit Transaction Form Section (hidden by default) -->
        <div id="transaction-form-section" class="card hidden">
            <h2 id="transaction-form-title" class="text-2xl font-semibold text-gray-700 mb-4">新增交易</h2>
            <form id="transaction-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">交易類型</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transactionType" value="income" checked>
                            <span class="ml-2 text-gray-700">收入</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transactionType" value="expense">
                            <span class="ml-2 text-gray-700">支出</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="date" id="transaction-date" name="date" required class="w-full">
                </div>
                <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金額 (NT$)</label>
                    <input type="number" id="transaction-amount" name="amount" min="0" step="1" required class="w-full">
                </div>
                <div>
                    <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                    <select id="transaction-category" name="category" required class="w-full">
                        <!-- Categories will be dynamically loaded/selected based on type -->
                    </select>
                </div>
                <div>
                    <label for="payment-method" class="block text-sm font-medium text-gray-700 mb-1">付款/收款方式</label>
                    <select id="payment-method" name="paymentMethod" class="w-full">
                        <option value="">請選擇方式</option>
                        <option value="銀行轉帳">銀行轉帳</option>
                        <option value="現金">現金</option>
                        <option value="支票">支票</option>
                        <option value="信用卡">信用卡</option>
                    </select>
                </div>
                <div>
                    <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-1">發票/收據號碼</label>
                    <input type="text" id="invoice-number" name="invoiceNumber" class="w-full" placeholder="例如：AB12345678">
                </div>
                <div id="expense-specific-fields">
                    <div>
                        <label for="tax-id" class="block text-sm font-medium text-gray-700 mb-1">供應商統一編號</label>
                        <input type="text" id="tax-id" name="taxId" class="w-full" maxlength="8" placeholder="例如：12345678">
                    </div>
                    <div>
                        <label for="supplier" class="block text-sm font-medium text-gray-700 mb-1">供應商/收款方</label>
                        <input type="text" id="supplier" name="supplier" class="w-full" placeholder="例如：XX材料行">
                    </div>
                </div>
                <div>
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                    <textarea id="transaction-description" name="description" rows="2" class="w-full"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-transaction-btn" class="btn-secondary">取消</button>
                    <button type="submit" class="btn-primary">儲存交易</button>
                </div>
                <input type="hidden" id="current-transaction-id">
                <input type="hidden" id="transaction-project-id">
            </form>
        </div>

        <!-- Custom Modal for Messages (Alert) -->
        <div id="alertDialog" class="modal">
            <div class="modal-content">
                <span class="close-button" id="alert-close-btn">&times;</span>
                <p id="alert-message" class="text-lg text-gray-700"></p>
                <div class="flex justify-end mt-4">
                    <button id="alert-ok-btn" class="btn-primary">確定</button>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Confirmation -->
        <div id="confirmDialog" class="modal">
            <div class="modal-content">
                <span class="close-button" id="confirm-close-btn">&times;</span>
                <p id="confirm-message" class="text-lg text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="confirm-cancel-btn" class="btn-secondary">取消</button>
                    <button id="confirm-ok-btn" class="btn-danger">確定</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // In-memory data storage (replaces Firebase)
        let allProjects = [];
        let allTransactions = [];
        let currentProjectId = null; // To keep track of the currently viewed project
        let confirmResolver = null; // For custom confirmation dialog
        let nextProjectId = 1; // Simple ID generator for projects
        let nextTransactionId = 1; // Simple ID generator for transactions

        // Chart.js instances
        let incomePieChartInstance = null;
        let expensePieChartInstance = null;
        let monthlyLineChartInstance = null;

        // Pre-defined categories for income and expense
        const incomeCategories = ['專案收入', '其他收入'];
        const expenseCategories = ['材料費', '施工費', '外包設計費', '運輸費', '水電瓦斯費', '租金', '辦公用品費', '交際費', '雜項支出', '其他支出'];
        const paymentMethods = ['銀行轉帳', '現金', '支票', '信用卡'];
        const projectStatuses = ['規劃中', '施工中', '驗收中', '已結案', '暫停'];


        // --- Utility Functions ---

        /**
         * Displays a custom alert modal message.
         * @param {string} message The message to display.
         * @returns {Promise<void>} A promise that resolves when the user clicks OK.
         */
        function showAlert(message) {
            const modal = document.getElementById('alertDialog');
            const modalMessage = document.getElementById('alert-message');
            const closeButton = document.getElementById('alert-close-btn');
            const okButton = document.getElementById('alert-ok-btn');

            modalMessage.textContent = message;
            modal.style.display = 'flex'; // Use flex to center

            return new Promise(resolve => {
                const closeHandler = () => {
                    modal.style.display = 'none';
                    closeButton.removeEventListener('click', closeHandler);
                    okButton.removeEventListener('click', closeHandler);
                    resolve();
                };
                closeButton.addEventListener('click', closeHandler);
                okButton.addEventListener('click', closeHandler);
                modal.addEventListener('click', (e) => { // Close if clicking outside modal content
                    if (e.target === modal) {
                        closeHandler();
                    }
                });
            });
        }

        /**
         * Displays a custom confirmation modal message.
         * @param {string} message The message to display.
         * @returns {Promise<boolean>} A promise that resolves with true if confirmed, false otherwise.
         */
        function showConfirm(message) {
            const modal = document.getElementById('confirmDialog');
            const modalMessage = document.getElementById('confirm-message');
            const closeButton = document.getElementById('confirm-close-btn');
            const okButton = document.getElementById('confirm-ok-btn');
            const cancelButton = document.getElementById('confirm-cancel-btn');

            modalMessage.textContent = message;
            modal.style.display = 'flex';

            return new Promise(resolve => {
                confirmResolver = resolve; // Store resolver for later use

                const clickHandler = (result) => {
                    modal.style.display = 'none';
                    closeButton.removeEventListener('click', () => clickHandler(false));
                    okButton.removeEventListener('click', () => clickHandler(true));
                    cancelButton.removeEventListener('click', () => clickHandler(false));
                    modal.removeEventListener('click', outsideClickHandler); // Remove outside click listener
                    confirmResolver = null; // Clear resolver
                    resolve(result);
                };

                const outsideClickHandler = (e) => {
                    if (e.target === modal) {
                        clickHandler(false); // Treat outside click as cancel
                    }
                };

                closeButton.addEventListener('click', () => clickHandler(false));
                okButton.addEventListener('click', () => clickHandler(true));
                cancelButton.addEventListener('click', () => clickHandler(false));
                modal.addEventListener('click', outsideClickHandler);
            });
        }

        /**
         * Formats a number as New Taiwan Dollar (NTD).
         * @param {number} amount The amount to format.
         * @returns {string} Formatted string, e.g., "NT$ 10,000".
         */
        function formatCurrency(amount) {
            // Ensure amount is rounded to integer for display
            return `NT$ ${new Intl.NumberFormat('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(Math.round(amount || 0))}`;
        }

        /**
         * Populates the category dropdown based on the selected transaction type.
         * @param {string} type 'income' or 'expense'.
         * @param {string} selectedCategory The category to pre-select (optional).
         */
        function populateCategories(type, selectedCategory = '') {
            const categorySelect = document.getElementById('transaction-category');
            categorySelect.innerHTML = ''; // Clear existing options

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '請選擇類別';
            categorySelect.appendChild(defaultOption);

            const relevantCategories = type === 'income' ? incomeCategories : expenseCategories;
            relevantCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (category === selectedCategory) {
                    option.selected = true;
                }
                categorySelect.appendChild(option);
            });
        }

        /**
         * Toggles visibility of expense-specific fields in transaction form.
         * @param {string} type 'income' or 'expense'.
         */
        function toggleExpenseFields(type) {
            const expenseFields = document.getElementById('expense-specific-fields');
            if (type === 'expense') {
                expenseFields.classList.remove('hidden');
            } else {
                expenseFields.classList.add('hidden');
            }
        }

        /**
         * Populates the year selector dropdown.
         */
        function populateYearSelector() {
            const yearSelector = document.getElementById('year-selector');
            yearSelector.innerHTML = ''; // Clear existing options
            const currentYear = new Date().getFullYear();
            // Get min/max year from dummy data for more relevant range
            const allDates = allTransactions.map(t => new Date(t.date).getFullYear())
                                .concat(allProjects.map(p => new Date(p.startDate).getFullYear()));
            const minYear = allDates.length > 0 ? Math.min(...allDates) : currentYear - 4;
            const maxYear = allDates.length > 0 ? Math.max(...allDates) : currentYear;

            for (let year = maxYear; year >= minYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                if (year === currentYear) {
                    option.selected = true; // Default to current year
                }
                yearSelector.appendChild(option);
            }
        }

        // --- UI State Management ---

        /**
         * Shows a specific section and hides others.
         * @param {string} sectionId The ID of the section to show.
         */
        function showSection(sectionId) {
            const sections = ['dashboard-section', 'project-list-section', 'project-form-section', 'project-detail-section', 'transaction-form-section'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            // Update navigation bar active state
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            });
            if (sectionId === 'dashboard-section') {
                document.getElementById('nav-dashboard-btn').classList.add('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                document.getElementById('nav-dashboard-btn').classList.remove('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            } else if (sectionId === 'project-list-section' || sectionId === 'project-form-section' || sectionId === 'project-detail-section' || sectionId === 'transaction-form-section') {
                document.getElementById('nav-projects-btn').classList.add('bg-blue-600', 'text-white', 'shadow-md', 'transform', 'scale-105');
                document.getElementById('nav-projects-btn').classList.remove('bg-white', 'text-gray-700', 'hover:bg-blue-50', 'hover:text-blue-600');
            }
        }

        /**
         * Resets a form.
         * @param {HTMLFormElement} formElement The form to reset.
         */
        function resetForm(formElement) {
            formElement.reset();
            const hiddenIdField = formElement.querySelector('input[type="hidden"][id*="-id"]');
            if (hiddenIdField) {
                hiddenIdField.value = '';
            }
            // Reset radio buttons if they exist in the form
            formElement.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (radio.name === 'transactionType') { // Specific to transaction form
                    radio.checked = (radio.value === 'income');
                }
            });
            toggleExpenseFields('income'); // Reset expense fields visibility
        }

        // --- Data Operations (In-memory) ---

        /**
         * Updates all projects with their actual revenue, expense, and net profit from transactions.
         * This function is called after any project or transaction data change.
         */
        function updateAllProjectsAndTransactions() {
            allProjects = allProjects.map(project => {
                const projectTransactions = allTransactions.filter(t => t.projectId === project.id);
                const actualRevenue = projectTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                const actualExpense = projectTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                return {
                    ...project,
                    actualRevenue,
                    actualExpense,
                    actualNetProfit: actualRevenue - actualExpense
                };
            });
        }

        /**
         * Saves (adds or updates) a project in memory.
         * @param {object} projectData The project data.
         * @param {string} [projectId] The ID of the project to update (if editing).
         */
        async function saveProject(projectData, projectId = null) {
            try {
                projectData.estimatedRevenue = Math.round(parseFloat(projectData.estimatedRevenue || 0));

                if (projectId) {
                    const index = allProjects.findIndex(p => p.id === projectId);
                    if (index !== -1) {
                        allProjects[index] = { ...allProjects[index], ...projectData };
                        await showAlert("專案更新成功！");
                    } else {
                        await showAlert("找不到要更新的專案。");
                        return;
                    }
                } else {
                    const newProject = { id: `proj-${nextProjectId++}`, ...projectData, createdAt: new Date().toISOString() };
                    allProjects.push(newProject);
                    await showAlert("專案新增成功！");
                }
                updateAllProjectsAndTransactions(); // Recalculate actuals
                renderProjects(allProjects); // Re-render project list
                // Recalculate dashboard data and charts as well
                const selectedYear = document.getElementById('year-selector').value;
                const activeTimeRangeButton = document.querySelector('#dashboard-section .mb-8 button.bg-blue-600');
                let timeRange = 'year';
                if (activeTimeRangeButton) {
                    if (activeTimeRangeButton.id === 'time-range-month') timeRange = 'month';
                    if (activeTimeRangeButton.id === 'time-range-quarter') timeRange = 'quarter';
                }
                calculateOverallProfit(allProjects, allTransactions, timeRange, selectedYear);
                renderProjectProfitRanking(allProjects, allTransactions);
                renderCharts(allTransactions, selectedYear);

                resetForm(document.getElementById('project-form'));
                showSection('project-list-section');
            } catch (error) {
                console.error("Error saving project:", error);
                showAlert(`儲存專案失敗：${error.message}`);
            }
        }

        /**
         * Deletes a project and its associated transactions from memory.
         * @param {string} projectId The ID of the project to delete.
         */
        async function deleteProject(projectId) {
            const confirmed = await showConfirm("確定要刪除此專案及其所有交易記錄嗎？此操作無法復原。");
            if (!confirmed) {
                return;
            }

            try {
                allProjects = allProjects.filter(p => p.id !== projectId);
                allTransactions = allTransactions.filter(t => t.projectId !== projectId); // Delete associated transactions

                updateAllProjectsAndTransactions(); // Recalculate actuals
                renderProjects(allProjects); // Re-render project list
                // Recalculate dashboard data and charts as well
                const selectedYear = document.getElementById('year-selector').value;
                const activeTimeRangeButton = document.querySelector('#dashboard-section .mb-8 button.bg-blue-600');
                let timeRange = 'year';
                if (activeTimeRangeButton) {
                    if (activeTimeRangeButton.id === 'time-range-month') timeRange = 'month';
                    if (activeTimeRangeButton.id === 'time-range-quarter') timeRange = 'quarter';
                }
                calculateOverallProfit(allProjects, allTransactions, timeRange, selectedYear);
                renderProjectProfitRanking(allProjects, allTransactions);
                renderCharts(allTransactions, selectedYear);

                await showAlert("專案及其交易記錄已成功刪除。");
            } catch (error) {
                console.error("Error deleting project:", error);
                showAlert(`刪除專案失敗：${error.message}`);
            }
        }

        /**
         * Saves (adds or updates) a transaction in memory.
         * @param {object} transactionData The transaction data.
         * @param {string} projectId The ID of the project this transaction belongs to.
         * @param {string} [transactionId] The ID of the transaction to update (if editing).
         */
        async function saveTransaction(transactionData, projectId, transactionId = null) {
            try {
                transactionData.amount = Math.round(parseFloat(transactionData.amount || 0));

                if (transactionId) {
                    const index = allTransactions.findIndex(t => t.id === transactionId);
                    if (index !== -1) {
                        allTransactions[index] = { ...allTransactions[index], ...transactionData, projectId };
                        await showAlert("交易更新成功！");
                    } else {
                        await showAlert("找不到要更新的交易。");
                        return;
                    }
                } else {
                    const newTransaction = { id: `txn-${nextTransactionId++}`, ...transactionData, projectId, createdAt: new Date().toISOString() };
                    allTransactions.push(newTransaction);
                    await showAlert("交易新增成功！");
                }
                updateAllProjectsAndTransactions(); // Recalculate actuals
                if (currentProjectId) {
                    showProjectDetail(currentProjectId); // Re-render project detail
                }
                // Recalculate dashboard data and charts as well
                const selectedYear = document.getElementById('year-selector').value;
                const activeTimeRangeButton = document.querySelector('#dashboard-section .mb-8 button.bg-blue-600');
                let timeRange = 'year';
                if (activeTimeRangeButton) {
                    if (activeTimeRangeButton.id === 'time-range-month') timeRange = 'month';
                    if (activeTimeRangeButton.id === 'time-range-quarter') timeRange = 'quarter';
                }
                calculateOverallProfit(allProjects, allTransactions, timeRange, selectedYear);
                renderProjectProfitRanking(allProjects, allTransactions);
                renderCharts(allTransactions, selectedYear);
                
                resetForm(document.getElementById('transaction-form'));
            } catch (error) {
                console.error("Error saving transaction:", error);
                showAlert(`儲存交易失敗：${error.message}`);
            }
        }

        /**
         * Deletes a transaction from memory.
         * @param {string} transactionId The ID of the transaction to delete.
         */
        async function deleteTransaction(transactionId) {
            const confirmed = await showConfirm("確定要刪除此交易記錄嗎？");
            if (!confirmed) {
                return;
            }

            try {
                allTransactions = allTransactions.filter(t => t.id !== transactionId);

                updateAllProjectsAndTransactions(); // Recalculate actuals
                if (currentProjectId) {
                    showProjectDetail(currentProjectId); // Re-render project detail
                }
                // Recalculate dashboard data and charts as well
                const selectedYear = document.getElementById('year-selector').value;
                const activeTimeRangeButton = document.querySelector('#dashboard-section .mb-8 button.bg-blue-600');
                let timeRange = 'year';
                if (activeTimeRangeButton) {
                    if (activeTimeRangeButton.id === 'time-range-month') timeRange = 'month';
                    if (activeTimeRangeButton.id === 'time-range-quarter') timeRange = 'quarter';
                }
                calculateOverallProfit(allProjects, allTransactions, timeRange, selectedYear);
                renderProjectProfitRanking(allProjects, allTransactions);
                renderCharts(allTransactions, selectedYear);

                await showAlert("交易記錄已成功刪除。");
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showAlert(`刪除交易失敗：${error.message}`);
            }
        }

        // --- Rendering Functions ---

        /**
         * Renders the list of projects.
         * @param {Array<object>} projects The array of project objects.
         */
        function renderProjects(projects) {
            const projectsContainer = document.getElementById('projects-container');
            const noProjectsMessage = document.getElementById('no-projects-message');
            
            projectsContainer.innerHTML = ''; // Clear existing projects
            noProjectsMessage.classList.add('hidden'); // Hide the message initially

            const searchTerm = document.getElementById('search-project-name').value.toLowerCase();
            const filterStartDate = document.getElementById('filter-start-date').value;
            const filterEndDate = document.getElementById('filter-end-date').value;

            const filteredProjects = projects.filter(project => {
                const matchesName = project.projectName.toLowerCase().includes(searchTerm);

                const projectStartDate = project.startDate ? new Date(project.startDate) : null;
                const projectEndDate = project.endDate ? new Date(project.endDate) : null;

                const filterStart = filterStartDate ? new Date(filterStartDate) : null;
                const filterEnd = filterEndDate ? new Date(filterEndDate) : null;

                let matchesDate = true;
                if (filterStart) {
                    matchesDate = matchesDate && projectStartDate && projectStartDate >= filterStart;
                }
                if (filterEnd) {
                    const adjustedFilterEnd = new Date(filterEnd);
                    adjustedFilterEnd.setHours(23, 59, 59, 999); // End of day
                    matchesDate = matchesDate && projectEndDate && projectEndDate <= adjustedFilterEnd;
                }
                return matchesName && matchesDate;
            });

            if (filteredProjects.length === 0) {
                noProjectsMessage.classList.remove('hidden');
                return;
            }

            // Create table structure
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">專案名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">客戶名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">狀態</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">開始日期</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">預估收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際支出</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">實際淨利</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="projects-table-body">
                </tbody>
            `;
            projectsContainer.appendChild(table);
            const tableBody = document.getElementById('projects-table-body');

            filteredProjects.forEach(project => {
                const actualNetProfit = project.actualNetProfit; // Already calculated in updateAllProjectsAndTransactions

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-800">${project.projectName}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.clientName || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${
                            project.status === '已結案' ? 'bg-green-100 text-green-800' :
                            project.status === '施工中' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${project.status || '未設定'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.startDate || '未設定'}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.estimatedRevenue || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.actualRevenue || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.actualExpense || 0)}</td>
                    <td class="py-3 px-4 text-right text-sm font-semibold ${actualNetProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(actualNetProfit)}
                    </td>
                    <td class="py-3 px-4 flex gap-2">
                        <button data-id="${project.id}" class="btn-info view-project-btn">查看詳情</button>
                        <button data-id="${project.id}" class="btn-secondary edit-project-btn">編輯</button>
                        <button data-id="${project.id}" class="btn-danger delete-project-btn">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach event listeners for project actions
            projectsContainer.querySelectorAll('.view-project-btn').forEach(button => {
                button.onclick = () => showProjectDetail(button.dataset.id);
            });
            projectsContainer.querySelectorAll('.edit-project-btn').forEach(button => {
                button.onclick = () => editProject(button.dataset.id);
            });
            projectsContainer.querySelectorAll('.delete-project-btn').forEach(button => {
                button.onclick = () => deleteProject(button.dataset.id);
            });
        }

        /**
         * Displays the details and transactions for a specific project.
         * @param {string} projectId The ID of the project to display.
         */
        async function showProjectDetail(projectId) {
            currentProjectId = projectId; // Set the current project ID

            const project = allProjects.find(p => p.id === projectId);

            if (!project) {
                await showAlert("找不到此專案。");
                showSection('project-list-section');
                return;
            }

            document.getElementById('detail-project-name').textContent = project.projectName;
            document.getElementById('detail-client-name').textContent = project.clientName || 'N/A';
            document.getElementById('detail-project-status').textContent = project.status || '未設定';
            document.getElementById('detail-estimated-revenue').textContent = formatCurrency(project.estimatedRevenue || 0);
            document.getElementById('detail-start-date').textContent = project.startDate || '未設定';
            document.getElementById('detail-end-date').textContent = project.endDate || '未設定';
            document.getElementById('detail-project-description').textContent = project.description || '無描述';

            document.getElementById('transaction-project-id').value = projectId; // Set hidden field for new transactions

            showSection('project-detail-section');

            const projectTransactions = allTransactions.filter(t => t.projectId === projectId).sort((a,b) => new Date(b.date) - new Date(a.date));
            renderTransactions(projectTransactions);
            calculateProjectProfit(projectTransactions);
        }

        /**
         * Renders the list of transactions for the current project.
         * @param {Array<object>} transactions The array of transaction objects.
         */
        function renderTransactions(transactions) {
            const transactionsContainer = document.getElementById('transactions-container');
            transactionsContainer.innerHTML = ''; // Clear existing transactions
            document.getElementById('no-transactions-message').classList.add('hidden');

            if (transactions.length === 0) {
                document.getElementById('no-transactions-message').classList.remove('hidden');
                return;
            }

            // Create table structure
            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">日期</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">類型</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">金額 (NT$)</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">類別</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">付款/收款方式</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">發票/收據號碼</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">供應商/統一編號</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">備註</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">操作</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="transactions-table-body">
                </tbody>
            `;
            transactionsContainer.appendChild(table);
            const tableBody = document.getElementById('transactions-table-body');

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-50 transition-colors duration-150`;
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.date}</td>
                    <td class="py-3 px-4 text-sm font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.type === 'income' ? '收入' : '支出'}
                    </td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(transaction.amount)}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.category || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.paymentMethod || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">${transaction.invoiceNumber || '無'}</td>
                    <td class="py-3 px-4 text-sm text-gray-700">
                        ${transaction.type === 'expense' ? `${transaction.supplier || '無'} (${transaction.taxId || '無'})` : 'N/A'}
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600 max-w-[150px] truncate">${transaction.description || '無'}</td>
                    <td class="py-3 px-4 flex gap-2">
                        <button data-id="${transaction.id}" class="bg-yellow-500 text-white px-3.5 py-1.5 rounded-md text-sm hover:bg-yellow-600 transition-colors transform hover:scale-105 edit-transaction-btn">編輯</button>
                        <button data-id="${transaction.id}" class="bg-red-500 text-white px-3.5 py-1.5 rounded-md text-sm hover:bg-red-600 transition-colors transform hover:scale-105 delete-transaction-btn">刪除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach event listeners for transaction actions
            transactionsContainer.querySelectorAll('.edit-transaction-btn').forEach(button => {
                button.onclick = () => editTransaction(button.dataset.id);
            });
            transactionsContainer.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.onclick = () => deleteTransaction(button.dataset.id);
            });
        }

        /**
         * Calculates and displays the overall income, expense, and net profit based on a time range.
         * @param {Array<object>} projects The array of all project objects.
         * @param {Array<object>} transactions The array of all transaction objects.
         * @param {string} timeRange 'month', 'quarter', or 'year'.
         * @param {string} [selectedYear] The specific year to filter by (if timeRange is 'year' or year selector is used).
         */
        function calculateOverallProfit(projects, transactions, timeRange, selectedYear = new Date().getFullYear().toString()) {
            const now = new Date();
            let startDate = new Date();
            let endDate = new Date(now); // Clone now for endDate manipulation
            let periodTitle = '';

            if (timeRange === 'year') {
                startDate.setFullYear(parseInt(selectedYear), 0, 1); // First day of selected year
                endDate.setFullYear(parseInt(selectedYear), 11, 31); // Last day of selected year
                periodTitle = `${selectedYear}年`;
            } else if (timeRange === 'month') {
                startDate.setMonth(now.getMonth(), 1); // First day of current month
                endDate.setMonth(now.getMonth() + 1, 0); // Last day of current month
                periodTitle = '本月';
            } else if (timeRange === 'quarter') {
                const currentMonth = now.getMonth();
                const currentQuarterStartMonth = Math.floor(currentMonth / 3) * 3;
                startDate.setMonth(currentQuarterStartMonth, 1);
                endDate.setMonth(currentQuarterStartMonth + 3, 0); // Last day of current quarter
                periodTitle = '本季';
            }
            startDate.setHours(0, 0, 0, 0); // Start of the day for startDate
            endDate.setHours(23, 59, 59, 999); // End of the day for endDate

            const filteredTransactions = transactions.filter(txn => {
                const txnDate = new Date(txn.date); // Assuming txn.date is in YYYY-MM-DD format
                return txnDate >= startDate && txnDate <= endDate;
            });

            const totalIncome = filteredTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + Math.round(t.amount || 0), 0);

            const totalExpense = filteredTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + Math.round(t.amount || 0), 0);

            const netProfit = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('net-profit').textContent = formatCurrency(netProfit);
            document.getElementById('net-profit').classList.toggle('text-red-800', netProfit < 0);
            document.getElementById('net-profit').classList.toggle('text-green-800', netProfit >= 0);

            // Update titles
            document.getElementById('total-income-title').textContent = `${periodTitle}總收入`;
            document.getElementById('total-expense-title').textContent = `${periodTitle}總支出`;
            document.getElementById('net-profit-title').textContent = `${periodTitle}總淨利潤`;


            // Update time range button styles
            document.querySelectorAll('#dashboard-section .mb-8 button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            });
            // Only highlight if it's one of the specific buttons
            if (timeRange === 'month') {
                document.getElementById('time-range-month').classList.add('bg-blue-600', 'text-white', 'shadow-md');
                document.getElementById('time-range-month').classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            } else if (timeRange === 'quarter') {
                document.getElementById('time-range-quarter').classList.add('bg-blue-600', 'text-white', 'shadow-md');
                document.getElementById('time-range-quarter').classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            } else if (timeRange === 'year') {
                document.getElementById('time-range-year').classList.add('bg-blue-600', 'text-white', 'shadow-md');
                document.getElementById('time-range-year').classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            }
            // Ensure year selector value is set
            document.getElementById('year-selector').value = selectedYear;
        }

        /**
         * Calculates and displays the income, expense, and net profit for a specific project.
         * @param {Array<object>} transactions The array of transaction objects for the current project.
         */
        function calculateProjectProfit(transactions) {
            const projectIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
            const projectExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
            const projectNetProfit = projectIncome - projectExpense;
            const grossMargin = projectIncome > 0 ? ((projectNetProfit / projectIncome) * 100).toFixed(0) : 0;

            document.getElementById('detail-total-income').textContent = formatCurrency(projectIncome);
            document.getElementById('detail-total-expense').textContent = formatCurrency(projectExpense);
            document.getElementById('detail-net-profit').textContent = formatCurrency(projectNetProfit);
            document.getElementById('detail-net-profit').classList.toggle('text-red-800', projectNetProfit < 0);
            document.getElementById('detail-net-profit').classList.toggle('text-green-800', projectNetProfit >= 0);
            document.getElementById('detail-gross-margin').textContent = `毛利率: ${grossMargin}%`;
        }

        /**
         * Renders the project net profit ranking table on the dashboard.
         * @param {Array<object>} projects The array of all project objects (with actuals calculated).
         * @param {Array<object>} transactions The array of all transaction objects.
         */
        function renderProjectProfitRanking(projects, transactions) {
            const rankingContainer = document.getElementById('project-profit-ranking-container');
            const noRankingDataMessage = document.getElementById('no-ranking-data'); // Get the message element
            
            rankingContainer.innerHTML = ''; // Clear existing content
            noRankingDataMessage.classList.add('hidden'); // Hide the message initially

            const projectProfits = projects.map(project => {
                const projectTransactions = transactions.filter(t => t.projectId === project.id);
                const income = projectTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                const expense = projectTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.round(t.amount || 0), 0);
                return {
                    id: project.id,
                    name: project.projectName,
                    startDate: project.startDate,
                    endDate: project.endDate,
                    income: income,
                    expense: expense,
                    netProfit: income - expense
                };
            }).sort((a, b) => b.netProfit - a.netProfit); // Sort by net profit descending

            if (projectProfits.length === 0) {
                noRankingDataMessage.classList.remove('hidden'); // Show the message if no data
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-white';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-50">
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">專案名稱</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">開始日期</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">結束日期</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">收入</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">支出</th>
                        <th class="py-3 px-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">淨利</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="project-ranking-table-body">
                </tbody>
            `;
            rankingContainer.appendChild(table);
            const tableBody = document.getElementById('project-ranking-table-body');

            projectProfits.forEach(project => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-800">${project.name}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.startDate || '未設定'}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${project.endDate || '未設定'}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.income)}</td>
                    <td class="py-3 px-4 text-right text-sm text-gray-700">${formatCurrency(project.expense)}</td>
                    <td class="py-3 px-4 text-right text-sm font-semibold ${project.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(project.netProfit)}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Renders all charts on the dashboard.
         * @param {Array<object>} transactions All transactions.
         * @param {string} year The year for the monthly net profit chart.
         */
        function renderCharts(transactions, year) {
            // Filter transactions for the selected year for charts
            const yearTransactions = transactions.filter(txn => new Date(txn.date).getFullYear().toString() === year.toString());

            renderIncomePieChart(yearTransactions);
            renderExpensePieChart(yearTransactions);
            renderMonthlyNetProfitLineChart(yearTransactions, year);
        }

        /**
         * Renders the income category pie chart.
         * @param {Array<object>} transactions Transactions for the selected period.
         */
        function renderIncomePieChart(transactions) {
            if (incomePieChartInstance) {
                incomePieChartInstance.destroy();
            }

            const incomeData = transactions.filter(t => t.type === 'income');
            const aggregatedData = incomeData.reduce((acc, curr) => {
                acc[curr.category] = (acc[curr.category] || 0) + Math.round(curr.amount || 0);
                return acc;
            }, {});

            const labels = Object.keys(aggregatedData);
            const data = Object.values(aggregatedData);

            const ctx = document.getElementById('incomeCategoryPieChart').getContext('2d');
            const noDataMessage = document.getElementById('no-income-chart-data');

            if (labels.length === 0) {
                noDataMessage.classList.remove('hidden');
                document.getElementById('incomeCategoryPieChart').classList.add('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
                document.getElementById('incomeCategoryPieChart').classList.remove('hidden');
            }

            incomePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#4F46E5', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#6B7280'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the expense category pie chart.
         * @param {Array<object>} transactions Transactions for the selected period.
         */
        function renderExpensePieChart(transactions) {
            if (expensePieChartInstance) {
                expensePieChartInstance.destroy();
            }

            const expenseData = transactions.filter(t => t.type === 'expense');
            const aggregatedData = expenseData.reduce((acc, curr) => {
                acc[curr.category] = (acc[curr.category] || 0) + Math.round(curr.amount || 0);
                return acc;
            }, {});

            const labels = Object.keys(aggregatedData);
            const data = Object.values(aggregatedData);

            const ctx = document.getElementById('expenseCategoryPieChart').getContext('2d');
            const noDataMessage = document.getElementById('no-expense-chart-data');

            if (labels.length === 0) {
                noDataMessage.classList.remove('hidden');
                document.getElementById('expenseCategoryPieChart').classList.add('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
                document.getElementById('expenseCategoryPieChart').classList.remove('hidden');
            }

            expensePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#4F46E5', '#6B7280',
                            '#DC2626', '#D97706', '#059669', '#2563EB', '#3730A3', '#4B5563'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the monthly net profit line chart.
         * @param {Array<object>} transactions Transactions for the selected year.
         * @param {string} year The year for the chart.
         */
        function renderMonthlyNetProfitLineChart(transactions, year) {
            if (monthlyLineChartInstance) {
                monthlyLineChartInstance.destroy();
            }

            const monthlyData = Array(12).fill(0).map(() => ({ income: 0, expense: 0 })); // Initialize for 12 months

            transactions.forEach(txn => {
                const date = new Date(txn.date);
                const month = date.getMonth(); // 0-11
                if (txn.type === 'income') {
                    monthlyData[month].income += Math.round(txn.amount || 0);
                } else if (txn.type === 'expense') {
                    monthlyData[month].expense += Math.round(txn.amount || 0);
                }
            });

            const netProfits = monthlyData.map(data => data.income - data.expense);
            const labels = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];

            const ctx = document.getElementById('monthlyNetProfitLineChart').getContext('2d');
            const noDataMessage = document.getElementById('no-monthly-chart-data');
            document.getElementById('monthly-profit-year').textContent = year;

            if (transactions.length === 0) {
                noDataMessage.classList.remove('hidden');
                document.getElementById('monthlyNetProfitLineChart').classList.add('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
                document.getElementById('monthlyNetProfitLineChart').classList.remove('hidden');
            }

            monthlyLineChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '淨利潤 (NT$)',
                        data: netProfits,
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '金額 (NT$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Form Handling ---

        /**
         * Shows the project form for adding a new project.
         */
        function showAddProjectForm() {
            document.getElementById('project-form-title').textContent = '新增專案';
            resetForm(document.getElementById('project-form'));
            document.getElementById('project-status').value = '規劃中'; // Default status
            document.getElementById('estimated-revenue').value = ''; // Clear estimated revenue
            showSection('project-form-section');
        }

        /**
         * Populates the project form with existing data for editing.
         * @param {string} projectId The ID of the project to edit.
         */
        async function editProject(projectId) {
            const project = allProjects.find(p => p.id === projectId);
            if (!project) {
                await showAlert("找不到要編輯的專案。");
                return;
            }
            
            document.getElementById('project-form-title').textContent = '編輯專案';
            document.getElementById('current-project-id').value = projectId;
            document.getElementById('project-name').value = project.projectName || '';
            document.getElementById('client-name').value = project.clientName || '';
            document.getElementById('estimated-revenue').value = project.estimatedRevenue || '';
            document.getElementById('project-status').value = project.status || '規劃中';
            document.getElementById('start-date').value = project.startDate || '';
            document.getElementById('end-date').value = project.endDate || '';
            document.getElementById('project-description').value = project.description || '';
            showSection('project-form-section');
        }

        /**
         * Shows the transaction form for adding a new transaction to the current project.
         */
        function showAddTransactionForm() {
            document.getElementById('transaction-form-title').textContent = '新增交易';
            resetForm(document.getElementById('transaction-form'));
            // Set default date to today
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            populateCategories('income'); // Default to income categories
            toggleExpenseFields('income'); // Hide expense fields by default
            showSection('transaction-form-section');
        }

        /**
         * Populates the transaction form with existing data for editing.
         * @param {string} transactionId The ID of the transaction to edit.
         */
        async function editTransaction(transactionId) {
            const transaction = allTransactions.find(t => t.id === transactionId);
            if (!transaction) {
                await showAlert("找不到要編輯的交易。");
                return;
            }

            document.getElementById('transaction-form-title').textContent = '編輯交易';
            document.getElementById('current-transaction-id').value = transactionId;
            document.getElementById('transaction-date').value = transaction.date || '';
            
            // Set radio button for type
            document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
                radio.checked = (radio.value === transaction.type);
            });
            toggleExpenseFields(transaction.type); // Show/hide expense fields based on type

            document.getElementById('transaction-amount').value = transaction.amount || 0;
            populateCategories(transaction.type || 'income', transaction.category); // Populate categories based on existing type and select existing category
            document.getElementById('payment-method').value = transaction.paymentMethod || '';
            document.getElementById('invoice-number').value = transaction.invoiceNumber || '';
            document.getElementById('tax-id').value = transaction.taxId || '';
            document.getElementById('supplier').value = transaction.supplier || '';
            document.getElementById('transaction-description').value = transaction.description || '';
            showSection('transaction-form-section');
        }

        /**
         * Generates initial dummy data for projects and transactions.
         */
        function generateInitialDummyData() {
            const currentYear = new Date().getFullYear();
            allProjects = [];
            allTransactions = [];
            nextProjectId = 1;
            nextTransactionId = 1;

            // Generate data for current year and previous year
            for (let yearOffset = 0; yearOffset < 2; yearOffset++) { // 0 for current year, 1 for previous year
                const targetYear = currentYear - yearOffset;
                for (let month = 0; month < 12; month++) { // Generate for all 12 months of the target year
                    const startDate = new Date(targetYear, month, 1);
                    const endDate = new Date(targetYear, month + 1, 0); // Last day of the month

                    const projectName = `${targetYear}年${month + 1}月設計專案 ${String.fromCharCode(65 + (month + yearOffset * 12))}`;
                    const clientName = `客戶 ${String.fromCharCode(77 + (month + yearOffset * 12))}`;
                    const estimatedRevenue = Math.round(Math.random() * (1500000 - 500000) + 500000); // 50萬 - 150萬
                    const status = projectStatuses[Math.floor(Math.random() * projectStatuses.length)];

                    const newProject = {
                        id: `proj-${nextProjectId++}`,
                        projectName,
                        clientName,
                        status,
                        estimatedRevenue: estimatedRevenue,
                        startDate: startDate.toISOString().split('T')[0],
                        endDate: endDate.toISOString().split('T')[0],
                        description: `這是關於 ${projectName} 的虛擬描述。`,
                        createdAt: new Date().toISOString()
                    };
                    allProjects.push(newProject);

                    // Generate 3 income transactions for the project
                    for (let j = 0; j < 3; j++) {
                        const incomeAmount = Math.round(Math.random() * (estimatedRevenue / 3 * 1.2 - estimatedRevenue / 3 * 0.8) + estimatedRevenue / 3 * 0.8);
                        const incomeDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())).toISOString().split('T')[0];
                        const incomeCategory = incomeCategories[Math.floor(Math.random() * incomeCategories.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];

                        allTransactions.push({
                            id: `txn-${nextTransactionId++}`,
                            projectId: newProject.id,
                            type: 'income',
                            amount: incomeAmount,
                            date: incomeDate,
                            category: incomeCategory,
                            paymentMethod: paymentMethod,
                            invoiceNumber: `INV-${Math.random().toString(36).substring(2, 10).toUpperCase()}`,
                            taxId: '',
                            supplier: clientName,
                            description: `虛擬收入 - ${incomeCategory} ${j + 1}`,
                            createdAt: new Date().toISOString()
                        });
                    }

                    // Generate 3 expense transactions for the project
                    for (let j = 0; j < 3; j++) {
                        const expenseAmount = Math.round(Math.random() * (100000 - 5000) + 5000); // 5千 - 10萬
                        const expenseDate = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime())).toISOString().split('T')[0];
                        const expenseCategory = expenseCategories[Math.floor(Math.random() * expenseCategories.length)];
                        const paymentMethod = paymentMethods[Math.floor(Math.random() * paymentMethods.length)];
                        const supplierName = `供應商 ${Math.random().toString(36).substring(2, 6)}`;
                        const taxId = Math.floor(10000000 + Math.random() * 90000000).toString(); // 8-digit number

                        allTransactions.push({
                            id: `txn-${nextTransactionId++}`,
                            projectId: newProject.id,
                            type: 'expense',
                            amount: expenseAmount,
                            date: expenseDate,
                            category: expenseCategory,
                            paymentMethod: paymentMethod,
                            invoiceNumber: `EXP-${Math.random().toString(36).substring(2, 10).toUpperCase()}`,
                            taxId: taxId,
                            supplier: supplierName,
                            description: `虛擬支出 - ${expenseCategory} ${j + 1}`,
                            createdAt: new Date().toISOString()
                        });
                    }
                }
            }
            console.log("Dummy data generated:", allProjects, allTransactions);
        }

        /**
         * Initializes the application data and UI.
         */
        function initializeAppData() {
            generateInitialDummyData(); // Generate data on load
            updateAllProjectsAndTransactions(); // Calculate initial actuals
            populateYearSelector(); // Populate year dropdown
            
            // Set initial dashboard view to 'year' and current year
            const currentYear = new Date().getFullYear().toString();
            calculateOverallProfit(allProjects, allTransactions, 'year', currentYear);
            renderProjectProfitRanking(allProjects, allTransactions);
            renderCharts(allTransactions, currentYear);

            showSection('dashboard-section'); // Show dashboard initially
        }


        // --- Event Listeners ---

        window.onload = initializeAppData; // Initialize app data when the page loads

        // Navigation Bar Event Listeners
        document.getElementById('nav-dashboard-btn').addEventListener('click', () => showSection('dashboard-section'));
        document.getElementById('nav-projects-btn').addEventListener('click', () => {
            renderProjects(allProjects); // Ensure project list is fresh when navigating
            showSection('project-list-section');
        });

        // Dashboard Time Range Event Listeners
        document.getElementById('time-range-month').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'month', new Date().getFullYear().toString()));
        document.getElementById('time-range-quarter').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'quarter', new Date().getFullYear().toString()));
        document.getElementById('time-range-year').addEventListener('click', () => calculateOverallProfit(allProjects, allTransactions, 'year', new Date().getFullYear().toString()));
        document.getElementById('year-selector').addEventListener('change', (e) => {
            calculateOverallProfit(allProjects, allTransactions, 'year', e.target.value);
            renderCharts(allTransactions, e.target.value); // Re-render charts for selected year
        });

        // Dummy data generator button removed

        // Project List Search and Filter Event Listeners
        document.getElementById('search-project-name').addEventListener('input', () => renderProjects(allProjects));
        document.getElementById('filter-start-date').addEventListener('change', () => renderProjects(allProjects));
        document.getElementById('filter-end-date').addEventListener('change', () => renderProjects(allProjects));


        // Project Form Event Listeners
        document.getElementById('add-project-btn').addEventListener('click', showAddProjectForm);
        document.getElementById('cancel-project-btn').addEventListener('click', () => {
            resetForm(document.getElementById('project-form'));
            showSection('project-list-section');
        });
        document.getElementById('project-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const projectId = document.getElementById('current-project-id').value;
            const projectName = document.getElementById('project-name').value.trim();
            const clientName = document.getElementById('client-name').value.trim();
            const estimatedRevenue = parseFloat(document.getElementById('estimated-revenue').value);
            const status = document.getElementById('project-status').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const description = document.getElementById('project-description').value.trim();

            if (!projectName || !clientName || isNaN(estimatedRevenue) || estimatedRevenue < 0 || !status) {
                showAlert("請填寫所有必填欄位並確保預估收入有效。");
                return;
            }

            const projectData = { projectName, clientName, estimatedRevenue: Math.round(estimatedRevenue), status, startDate, endDate, description };
            saveProject(projectData, projectId || null);
        });

        // Project Detail Event Listeners
        document.getElementById('back-to-projects-btn').addEventListener('click', () => {
            currentProjectId = null; // Clear current project
            showSection('project-list-section');
        });
        document.getElementById('add-transaction-btn').addEventListener('click', showAddTransactionForm);
        document.getElementById('edit-project-info-btn').addEventListener('click', () => {
            // Re-use the existing editProject function, passing the currentProjectId
            if (currentProjectId) {
                editProject(currentProjectId);
            } else {
                showAlert("無法編輯專案資訊，請先選擇一個專案。");
            }
        });


        // Transaction Form Event Listeners
        document.querySelectorAll('input[name="transactionType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                populateCategories(e.target.value);
                toggleExpenseFields(e.target.value);
            });
        });

        document.getElementById('cancel-transaction-btn').addEventListener('click', () => {
            resetForm(document.getElementById('transaction-form'));
            if (currentProjectId) {
                showSection('project-detail-section'); // Go back to project detail
            } else {
                showSection('project-list-section'); // Fallback
            }
        });
        document.getElementById('transaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const transactionId = document.getElementById('current-transaction-id').value;
            const projectId = document.getElementById('transaction-project-id').value;
            const date = document.getElementById('transaction-date').value;
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const category = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const paymentMethod = document.getElementById('payment-method').value;
            const invoiceNumber = document.getElementById('invoice-number').value.trim();
            const taxId = document.getElementById('tax-id').value.trim();
            const supplier = document.getElementById('supplier').value.trim();
            const description = document.getElementById('transaction-description').value.trim();

            if (!date || !type || !category || isNaN(amount) || amount <= 0) {
                showAlert("請填寫所有必填欄位並確保金額有效。");
                return;
            }

            const transactionData = { date, type, category, amount: Math.round(amount), paymentMethod, invoiceNumber, taxId, supplier, description };
            saveTransaction(transactionData, projectId, transactionId || null);
        });

    </script>
</body>
</html>
